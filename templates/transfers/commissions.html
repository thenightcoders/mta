{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-3">ğŸ“Š Tableau des Commissions</h2>

  {% if is_manager %}
    <div class="d-flex justify-content-end mb-3">
      <a href="{% url 'clear_commissions' %}" class="btn btn-outline-danger btn-sm">
        ğŸ§¹ GÃ©rer les suppressions de commissions
      </a>
    </div>
  {% endif %}


  <form method="get" class="mb-4">
    <label for="period" class="form-label">Afficher par pÃ©riode :</label>
    <select name="period" id="period" onchange="this.form.submit()" class="form-select w-auto d-inline-block">
      <option value="day" {% if period == 'day' %}selected{% endif %}>Jour</option>
      <option value="week" {% if period == 'week' %}selected{% endif %}>Semaine</option>
      <option value="month" {% if period == 'month' %}selected{% endif %}>Mois</option>
      <option value="year" {% if period == 'year' %}selected{% endif %}>AnnÃ©e</option>
    </select>
  </form>

  {% if is_manager %}
    <h4 class="mt-4">ğŸ§® Total </h4>
    <ul class="list-group mb-3">
      {% for item in global_commissions %}
        <li class="list-group-item d-flex justify-content-between">
          <span>{{ item.period|date:"F Y" }}</span>
          <span>
            Agent : <strong>{{ item.total_agent }} â‚¬ </strong> </br>
            Manager : <strong>{{ item.total_manager }} â‚¬ </strong>
          </span>
        </li>
      {% endfor %}
    </ul>

    <h4>ğŸ“Œ Tous les commissions en â‚¬ </h4>
    <table class="table table-sm table-bordered">
      <thead>
        <tr>
          <th>Qui?</th><th>Son gain total</th><th>part des managers</th><th>Total Brut</th>
        </tr>
      </thead>
      <tbody>
        {% for agent in per_agent_totals %}
        <tr>
          <td>{{ agent.agent__username }}</td>
          <td>{{ agent.total }}</td>
          <td>{{ agent.total_manager }}</td>
          <td>{{ agent.total_commissions }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <h4 class="mb-3">Mes Commissions par {{ period_label }}</h4>
    <ul class="list-group mb-4">
      {% for item in commissions %}
        <li class="list-group-item d-flex justify-content-between">
          {{ item.period|date:"d m Y" }} :
          <strong>{{ item.total }}</strong>
        </li>
      {% empty %}
        <li class="list-group-item">Aucune commission trouvÃ©e.</li>
      {% endfor %}
    </ul>
  {% endif %}

  <h4 class="mt-4">ğŸ” DÃ©tails des Commissions</h4>
  <table class="table table-hover table-bordered">
    <thead>
      <tr>
        {% if is_manager %}<th>Agent</th>{% endif %}
        <th>Date</th>
        <th>Tranfert</th>
        <th>Montant du transfert</th>
        <th>Commission</th>
        <th>Manager</th>
        <th>identifiant unique</th>
        {% comment %} <th>Config</th> {% endcomment %}
      </tr>
    </thead>
    <tbody>
      {% for c in detailed_commissions %}
      <tr>
        {% if is_manager %}<td>{{ c.agent.username }}</td>{% endif %}
        <td>{{ c.created_at|date:"d/m/Y H:i" }}</td>
        <td><a href="{% url 'transfer_detail' transfer_id=c.transfer.id %}">voir le transfert</a></td>
        <td>{{ c.transfer.amount }} {{ c.transfer.sent_currency }}</td>
        <td>{{ c.declaring_agent_amount }}</td>
        <td>{{ c.transfer.validated_by.username }}</td>
        <td>{{ c.id }}</td>
        {% comment %} <td>
          {% if c.config_used %}
            <a href="{% url 'toggle_commission_config' config_id=c.config_used.id %}" target="_blank">#{{ c.config_used.id }}</a>
          {% else %}
            -
          {% endif %}
        </td> {% endcomment %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>
{% endblock %}
